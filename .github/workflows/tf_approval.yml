name: Terraform Approval Reusable Workflow

on:
  workflow_call:
    inputs:
      region:
        required: true
        type: string
      environment:
        required: true
        type: string
      working_directory:
        required: true
        type: string

permissions:
  contents: read
  issues: write

jobs:
  terraform_plan:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ inputs.region }}" >> $GITHUB_ENV

      - name: Terraform Init
        run: terraform init -backend-config=backend.config

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -no-color > plan.txt

      - name: Create Approval Issue
        run: |
          PLAN_CONTENT=$(cat plan.txt | head -c 60000)

          ISSUE_BODY=$(jq -n \
            --arg title "Terraform Approval Required - ${{ inputs.environment }}" \
            --arg body "Terraform plan generated for environment: ${{ inputs.environment }}

Region: ${{ inputs.region }}

Workflow Run:
${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

Review plan and approve before apply." \
            '{
              title: $title,
              body: $body,
              labels: ["terraform","approval"]
            }')

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues \
            -d "$ISSUE_BODY"
