name: CI/CD workflow

run-name: >
  Terraform -
  ${{ github.event.inputs.environment }} -
  ${{ github.event.inputs.region }} -
  ${{ github.ref_name }}

on:
  workflow_dispatch:
    inputs:
      region:
        description: Select the region
        required: true
        type: choice
        default: us-east-1
        options:
          - us-east-1
          - eu-west-1

      environment:
        description: Select the env
        required: true
        type: choice
        default: dev
        options:
          - dev
          - prod

  issue_comment:
    types: [created]
    
permissions:
  contents: read
  issues: write

jobs:
  tf_plan:
    name: Validate and Plan
    runs-on: ubuntu-latest

    environment: ${{ github.event.inputs.environment }}

    defaults:
      run:
        working-directory: ./terraform-eks

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ github.event.inputs.region }}" >> $GITHUB_ENV

      - name: Verify AWS Identity
        run: aws sts get-caller-identity

      - name: Terraform Init
        run: terraform init -backend-config=backend.config

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -no-color > plan.txt

      - name: Create Custom Approval Issue
        run: |
          PLAN_CONTENT=$(cat plan.txt | head -c 60000)

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GIT_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues \
            -d "{
              \"title\": \"Terraform Approval Required - ${{ github.run_name }}\",
              \"body\": \"## Terraform Plan Approval Required ðŸš€\n\n**Environment:** ${{ github.event.inputs.environment }}\n**Region:** ${{ github.event.inputs.region }}\n**Branch:** ${{ github.ref_name }}\n\n---\n\n### Plan Output:\n\`\`\`\n$PLAN_CONTENT\n\`\`\`\n\n---\n\nReview workflow run:\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nPlease approve before running apply.\",
              \"labels\": [\"terraform\", \"approval\"]
            }"

      - name: Stop After Issue Creation
        run: echo "Approval issue created. Waiting for manual approval."
